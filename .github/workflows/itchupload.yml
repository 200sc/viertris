name: itchio-pusher

on: [push]

env: 
  BUTLER_API_KEY: ${{ secrets.BUTLER_API_KEY }}
  
jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
      with:
        path: 'go/src/github.com/${{ github.repository }}'
    
    - uses: actions/setup-go@v2
      with:
        go-version: '^1.17'
    
    - name: Determine Build Info
      id: info
      run:  >-
        stableRelease="";

        fullRepoPath="${{github.repository}}";

        build="${{ github.event.inputs.buildversion }}"; 
        echo "::group::retrieval from file";
        cd go/src/github.com/$fullRepoPath;
        build=$(cat ./version.json | jq '.version' );
        echo "found build of $build";
        if [[  -z "$build" ]]; then
        echo "Bad format of version.json exiting" && exit 1; 
        fi;
        oldSHA=$(git log -n 1 --pretty=format:%H -- version.json);
        if [[ "$oldSHA" == "${{ github.sha }}" ]]; then 
          stableRelease="true";
        fi;
        echo "::endgroup::";
        echo "Setting Build Version as $build";
        echo "::set-output name=VERSION::$(echo $build)";
        echo "Is Stable: $stableRelease";
        echo "::set-output name=STABLE_RELEASE::$(echo $stableRelease)";

    - name: Build Game      
      run: |
        cd go/src/github.com/${{ github.repository }}/build
        go run build.go
    - name: Zip WASM
      run: |
        cd go/src/github.com/${{ github.repository }}/build
        zip -r js-wasm.zip js-wasm 

    - name: Download Butler
      run: |
        curl -L -o butler.zip https://broth.itch.ovh/butler/linux-amd64/LATEST/archive/default
        unzip -qq butler.zip      
  
    - name: hide_creds
      run: |
        echo "::add-mask::${{  secrets.BUTLER_API_KEY  }}";
        echo "${{  secrets.BUTLER_API_KEY  }}" >> butler_creds
      
    - name: attempt upload js
      run: ./butler -i ./butler_creds push go/src/github.com/${{ github.repository }}/build/js-wasm.zip twohundredscythes/viertris:js-beta --userversion "${{ steps.info.outputs.VERSION }}-${{ github.run_number }}"

    - name: upload beta 
      run: |
        for osarch in windows-386, windows-amd64, windows-arm, windows-arm64, linux-amd64, linux-arm, linux-arm64; do
          ./butler -i ./butler_creds push go/src/github.com/${{ github.repository }}/build/$osarch twohundredscythes/viertris:$osarch-beta --userversion "${{ steps.info.outputs.VERSION }}-${{ github.run_number }}"
        done
        
    - name: upload stable
      if: ${{ steps.info.outputs.STABLE_RELEASE == 'true' }}
      run: | 
        for osarch in windows-386, windows-amd64, windows-arm, windows-arm64, linux-amd64, linux-arm, linux-arm64; do
          ./butler -i ./butler_creds push go/src/github.com/${{ github.repository }}/build/$osarch twohundredscythes/viertris:$osarch-stable --userversion ${{ steps.info.outputs.VERSION }}
        done
